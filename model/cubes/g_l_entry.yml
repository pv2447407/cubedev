cubes:
  - name: g_l_entry
    sql_table: "\"BUSINESS_CENTRAL\".\"G_L_ENTRY\""
    data_source: default

    joins:
      - name: company
        sql: "{CUBE}.\"COMPANY_ID\" = {company}.\"ID\""
        relationship: many_to_one
      
      - name: g_l_account
        sql: "{CUBE}.\"G_LACCOUNT_NO\" = {g_l_account}.\"NO\" AND {CUBE}.\"COMPANY_ID\" = {g_l_account}.\"COMPANY_ID\""
        relationship: many_to_one
      

    dimensions:
      - name: g_laccount_no
        sql: "{CUBE}.\"G_LACCOUNT_NO\""
        type: string

      - name: shortcut_dimension_7_code
        sql: "{CUBE}.\"SHORTCUT_DIMENSION_7_CODE\""
        type: string

      - name: no_series
        sql: "{CUBE}.\"NO_SERIES\""
        type: string

      - name: tax_area_code
        sql: "{CUBE}.\"TAX_AREA_CODE\""
        type: string

      - name: reversed
        sql: "{CUBE}.\"REVERSED\""
        type: boolean

      - name: gst_hst
        sql: "{CUBE}.\"GST_HST\""
        type: string

      - name: source_type
        sql: "{CUBE}.\"SOURCE_TYPE\""
        type: string

      - name: company_id
        sql: "{CUBE}.\"COMPANY_ID\""
        type: string

      - name: user_id
        sql: "{CUBE}.\"USER_ID\""
        type: string

      - name: journal_templ_name
        sql: "{CUBE}.\"JOURNAL_TEMPL_NAME\""
        type: string

      - name: shortcut_dimension_3_code
        sql: "{CUBE}.\"SHORTCUT_DIMENSION_3_CODE\""
        type: string

      - name: additional_currency_amount
        sql: "{CUBE}.\"ADDITIONAL_CURRENCY_AMOUNT\""
        type: string

      - name: quantity
        sql: "{CUBE}.\"QUANTITY\""
        type: string

      - name: prior_year_entry
        sql: "{CUBE}.\"PRIOR_YEAR_ENTRY\""
        type: boolean

      - name: system_modified_by
        sql: "{CUBE}.\"SYSTEM_MODIFIED_BY\""
        type: string

      - name: gen_bus_posting_group
        sql: "{CUBE}.\"GEN_BUS_POSTING_GROUP\""
        type: string

      - name: shortcut_dimension_5_code
        sql: "{CUBE}.\"SHORTCUT_DIMENSION_5_CODE\""
        type: string

      - name: non_deductible_vatamount
        sql: "{CUBE}.\"NON_DEDUCTIBLE_VATAMOUNT\""
        type: string

      - name: system_id
        sql: "{CUBE}.\"SYSTEM_ID\""
        type: string
        primary_key: true

      - name: fa_entry_type
        sql: "{CUBE}.\"FA_ENTRY_TYPE\""
        type: string

      - name: shortcut_dimension_6_code
        sql: "{CUBE}.\"SHORTCUT_DIMENSION_6_CODE\""
        type: string

      - name: credit_amount
        sql: "{CUBE}.\"CREDIT_AMOUNT\""
        type: string

      - name: system_created_by
        sql: "{CUBE}.\"SYSTEM_CREATED_BY\""
        type: string

      - name: global_dimension_2_code
        sql: "{CUBE}.\"GLOBAL_DIMENSION_2_CODE\""
        type: string

      - name: ste_transaction_id
        sql: "{CUBE}.\"STE_TRANSACTION_ID\""
        type: string

      - name: ic_partner_code
        sql: "{CUBE}.\"IC_PARTNER_CODE\""
        type: string

      - name: non_deductible_vatamount_acy
        sql: "{CUBE}.\"NON_DEDUCTIBLE_VATAMOUNT_ACY\""
        type: string

      - name: gen_prod_posting_group
        sql: "{CUBE}.\"GEN_PROD_POSTING_GROUP\""
        type: string

      - name: account_id
        sql: "{CUBE}.\"ACCOUNT_ID\""
        type: string

      - name: vat_bus_posting_group
        sql: "{CUBE}.\"VAT_BUS_POSTING_GROUP\""
        type: string

      - name: description
        sql: "{CUBE}.\"DESCRIPTION\""
        type: string

      - name: amount
        sql: "{CUBE}.\"AMOUNT\""
        type: string

      - name: shortcut_dimension_8_code
        sql: "{CUBE}.\"SHORTCUT_DIMENSION_8_CODE\""
        type: string

      - name: vat_prod_posting_group
        sql: "{CUBE}.\"VAT_PROD_POSTING_GROUP\""
        type: string

      - name: gen_posting_type
        sql: "{CUBE}.\"GEN_POSTING_TYPE\""
        type: string

      - name: reason_code
        sql: "{CUBE}.\"REASON_CODE\""
        type: string

      - name: add_currency_debit_amount
        sql: "{CUBE}.\"ADD_CURRENCY_DEBIT_AMOUNT\""
        type: string

      - name: document_type
        sql: "{CUBE}.\"DOCUMENT_TYPE\""
        type: string

      - name: job_no
        sql: "{CUBE}.\"JOB_NO\""
        type: string

      - name: document_no
        sql: "{CUBE}.\"DOCUMENT_NO\""
        type: string

      - name: business_unit_code
        sql: "{CUBE}.\"BUSINESS_UNIT_CODE\""
        type: string

      - name: vat_amount
        sql: "{CUBE}.\"VAT_AMOUNT\""
        type: string

      - name: external_document_no
        sql: "{CUBE}.\"EXTERNAL_DOCUMENT_NO\""
        type: string

      - name: global_dimension_1_code
        sql: "{CUBE}.\"GLOBAL_DIMENSION_1_CODE\""
        type: string

      - name: source_no
        sql: "{CUBE}.\"SOURCE_NO\""
        type: string

      - name: shortcut_dimension_4_code
        sql: "{CUBE}.\"SHORTCUT_DIMENSION_4_CODE\""
        type: string

      - name: add_currency_credit_amount
        sql: "{CUBE}.\"ADD_CURRENCY_CREDIT_AMOUNT\""
        type: string

      - name: use_tax
        sql: "{CUBE}.\"USE_TAX\""
        type: boolean

      - name: bal_account_type
        sql: "{CUBE}.\"BAL_ACCOUNT_TYPE\""
        type: string

      - name: bal_account_no
        sql: "{CUBE}.\"BAL_ACCOUNT_NO\""
        type: string

      - name: g_laccount_name
        sql: "{CUBE}.\"G_LACCOUNT_NAME\""
        type: string

      - name: source_code
        sql: "{CUBE}.\"SOURCE_CODE\""
        type: string

      - name: tax_liable
        sql: "{CUBE}.\"TAX_LIABLE\""
        type: boolean

      - name: comment
        sql: "{CUBE}.\"COMMENT\""
        type: string

      - name: journal_batch_name
        sql: "{CUBE}.\"JOURNAL_BATCH_NAME\""
        type: string

      - name: system_created_entry
        sql: "{CUBE}.\"SYSTEM_CREATED_ENTRY\""
        type: boolean

      - name: allocation_account_no
        sql: "{CUBE}.\"ALLOCATION_ACCOUNT_NO\""
        type: string

      - name: prod_order_no
        sql: "{CUBE}.\"PROD_ORDER_NO\""
        type: string

      - name: debit_amount
        sql: "{CUBE}.\"DEBIT_AMOUNT\""
        type: string

      - name: tax_group_code
        sql: "{CUBE}.\"TAX_GROUP_CODE\""
        type: string

      - name: system_created_at
        sql: "{CUBE}.\"SYSTEM_CREATED_AT\""
        type: time

      - name: vat_reporting_date
        sql: "{CUBE}.\"VAT_REPORTING_DATE\""
        type: time

      - name: last_modified_date_time
        sql: "{CUBE}.\"LAST_MODIFIED_DATE_TIME\""
        type: time

      - name: system_modified_at
        sql: "{CUBE}.\"SYSTEM_MODIFIED_AT\""
        type: time

      - name: posting_date
        sql: "{CUBE}.\"POSTING_DATE\""
        type: time

      - name: document_date
        sql: "{CUBE}.\"DOCUMENT_DATE\""
        type: time

    measures:
      - name: count
        type: count

      - name: dimension_changes_count
        sql: "{CUBE}.\"DIMENSION_CHANGES_COUNT\""
        type: sum
      
      - name: total_amount
        sql: "{CUBE}.\"AMOUNT\""
        type: sum
        
      - name: total_debit_amount
        sql: "{CUBE}.\"DEBIT_AMOUNT\""
        type: sum
        
      - name: total_credit_amount
        sql: "{CUBE}.\"CREDIT_AMOUNT\""
        type: sum
        
      - name: avg_amount
        sql: "{CUBE}.\"AMOUNT\""
        type: avg
        
      - name: max_amount
        sql: "{CUBE}.\"AMOUNT\""
        type: max
        
      - name: min_amount
        sql: "{CUBE}.\"AMOUNT\""
        type: min
        
      - name: unique_documents
        sql: "{CUBE}.\"DOCUMENT_NO\""
        type: count_distinct
        
      - name: unique_sources
        sql: "{CUBE}.\"SOURCE_NO\""
        type: count_distinct
        
      - name: unique_jobs
        sql: "{CUBE}.\"JOB_NO\""
        type: count_distinct
        
      # Period-based measures
      - name: current_period_amount
        sql: "{CUBE}.\"AMOUNT\""
        type: sum
        filters:
          - sql: "DATE_TRUNC('month', {CUBE}.\"POSTING_DATE\") = DATE_TRUNC('month', CURRENT_DATE())"
            
      - name: prior_period_amount
        sql: "{CUBE}.\"AMOUNT\""
        type: sum
        filters:
          - sql: "DATE_TRUNC('month', {CUBE}.\"POSTING_DATE\") = DATE_TRUNC('month', DATEADD('month', -1, CURRENT_DATE()))"
            
      - name: current_year_amount
        sql: "{CUBE}.\"AMOUNT\""
        type: sum
        filters:
          - sql: "YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE())"
            
      - name: prior_year_amount
        sql: "{CUBE}.\"AMOUNT\""
        type: sum
        filters:
          - sql: "YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE()) - 1"
            
      - name: period_over_period_change
        sql: "SUM(CASE WHEN DATE_TRUNC('month', {CUBE}.\"POSTING_DATE\") = DATE_TRUNC('month', CURRENT_DATE()) THEN {CUBE}.\"AMOUNT\" ELSE 0 END) - SUM(CASE WHEN DATE_TRUNC('month', {CUBE}.\"POSTING_DATE\") = DATE_TRUNC('month', DATEADD('month', -1, CURRENT_DATE())) THEN {CUBE}.\"AMOUNT\" ELSE 0 END)"
        type: number
        
      - name: year_over_year_change
        sql: "SUM(CASE WHEN YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE()) THEN {CUBE}.\"AMOUNT\" ELSE 0 END) - SUM(CASE WHEN YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE()) - 1 THEN {CUBE}.\"AMOUNT\" ELSE 0 END)"
        type: number
      
      # Trial Balance specific measures
      - name: opening_balance
        type: sum
        sql: "{CUBE}.\"AMOUNT\""
        title: Opening Balance
        description: Sum of all amounts up to the start of the period
        filters:
          - sql: "{CUBE}.\"POSTING_DATE\" < DATE_TRUNC('year', CURRENT_DATE())"
        format: currency
      
      - name: period_debit
        type: sum
        sql: "{CUBE}.\"DEBIT_AMOUNT\""
        title: Period Debit
        description: Debit amounts for the current period
        format: currency
      
      - name: period_credit
        type: sum
        sql: "{CUBE}.\"CREDIT_AMOUNT\""
        title: Period Credit
        description: Credit amounts for the current period
        format: currency
      
      - name: net_change_period
        type: number
        sql: "SUM({CUBE}.\"DEBIT_AMOUNT\") - SUM({CUBE}.\"CREDIT_AMOUNT\")"
        title: Net Change
        description: Net change in the period (Debits - Credits)
        format: currency
      
      - name: closing_balance
        type: number
        sql: "SUM({CUBE}.\"AMOUNT\")"
        title: Closing Balance
        description: Cumulative balance including opening and period changes
        format: currency
      
      - name: ytd_debit
        type: sum
        sql: "{CUBE}.\"DEBIT_AMOUNT\""
        title: Year-to-Date Debit
        filters:
          - sql: "YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE())"
        format: currency
      
      - name: ytd_credit
        type: sum
        sql: "{CUBE}.\"CREDIT_AMOUNT\""
        title: Year-to-Date Credit
        filters:
          - sql: "YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE())"
        format: currency
      
      - name: ytd_net_change
        type: number
        sql: "SUM(CASE WHEN YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE()) THEN {CUBE}.\"DEBIT_AMOUNT\" - {CUBE}.\"CREDIT_AMOUNT\" ELSE 0 END)"
        title: Year-to-Date Net Change
        format: currency
      
      - name: mtd_amount
        type: sum
        sql: "{CUBE}.\"AMOUNT\""
        title: Month-to-Date Amount
        filters:
          - sql: "DATE_TRUNC('month', {CUBE}.\"POSTING_DATE\") = DATE_TRUNC('month', CURRENT_DATE())"
        format: currency
      
      - name: qtd_amount
        type: sum
        sql: "{CUBE}.\"AMOUNT\""
        title: Quarter-to-Date Amount
        filters:
          - sql: "DATE_TRUNC('quarter', {CUBE}.\"POSTING_DATE\") = DATE_TRUNC('quarter', CURRENT_DATE())"
        format: currency

    segments:
      # Fiscal Year Segments
      - name: current_fiscal_year
        sql: "YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE())"
        title: Current Fiscal Year
        description: Filter for current fiscal year transactions
      
      - name: prior_fiscal_year
        sql: "YEAR({CUBE}.\"POSTING_DATE\") = YEAR(CURRENT_DATE()) - 1"
        title: Prior Fiscal Year
        description: Filter for prior fiscal year transactions
      
      - name: current_fiscal_quarter
        sql: "DATE_TRUNC('quarter', {CUBE}.\"POSTING_DATE\") = DATE_TRUNC('quarter', CURRENT_DATE())"
        title: Current Fiscal Quarter
        description: Filter for current quarter transactions
      
      - name: current_fiscal_month
        sql: "DATE_TRUNC('month', {CUBE}.\"POSTING_DATE\") = DATE_TRUNC('month', CURRENT_DATE())"
        title: Current Fiscal Month
        description: Filter for current month transactions
      
      # Department/Dimension Segments
      - name: has_dimension_1
        sql: "{CUBE}.\"GLOBAL_DIMENSION_1_CODE\" IS NOT NULL AND {CUBE}.\"GLOBAL_DIMENSION_1_CODE\" != ''"
        title: Has Department Code
        description: Entries with Global Dimension 1 (typically Department)
      
      - name: has_dimension_2
        sql: "{CUBE}.\"GLOBAL_DIMENSION_2_CODE\" IS NOT NULL AND {CUBE}.\"GLOBAL_DIMENSION_2_CODE\" != ''"
        title: Has Project Code
        description: Entries with Global Dimension 2 (typically Project)
      
      - name: has_business_unit
        sql: "{CUBE}.\"BUSINESS_UNIT_CODE\" IS NOT NULL AND {CUBE}.\"BUSINESS_UNIT_CODE\" != ''"
        title: Has Business Unit
        description: Entries with Business Unit assigned
      
      # Date Range Segments
      - name: last_30_days
        sql: "{CUBE}.\"POSTING_DATE\" >= DATEADD('day', -30, CURRENT_DATE())"
        title: Last 30 Days
        description: Transactions in the last 30 days
      
      - name: last_90_days
        sql: "{CUBE}.\"POSTING_DATE\" >= DATEADD('day', -90, CURRENT_DATE())"
        title: Last 90 Days
        description: Transactions in the last 90 days
      
      - name: last_12_months
        sql: "{CUBE}.\"POSTING_DATE\" >= DATEADD('month', -12, CURRENT_DATE())"
        title: Last 12 Months
        description: Transactions in the last 12 months
      
      # Transaction Type Segments
      - name: journal_entries
        sql: "{CUBE}.\"SOURCE_TYPE\" = 'General Journal'"
        title: Journal Entries
        description: General journal entries only
      
      - name: customer_entries
        sql: "{CUBE}.\"SOURCE_TYPE\" = 'Customer'"
        title: Customer Entries
        description: Customer-related GL entries
      
      - name: vendor_entries
        sql: "{CUBE}.\"SOURCE_TYPE\" = 'Vendor'"
        title: Vendor Entries
        description: Vendor-related GL entries
      
      - name: bank_entries
        sql: "{CUBE}.\"SOURCE_TYPE\" = 'Bank Account'"
        title: Bank Entries
        description: Bank-related GL entries
      
      # Posted vs System Generated
      - name: manual_entries
        sql: "{CUBE}.\"SYSTEM_CREATED_ENTRY\" = false"
        title: Manual Entries
        description: Manually created entries only
      
      - name: system_entries
        sql: "{CUBE}.\"SYSTEM_CREATED_ENTRY\" = true"
        title: System Entries
        description: System-generated entries only
      
      # Reversal Status
      - name: not_reversed
        sql: "{CUBE}.\"REVERSED\" = false OR {CUBE}.\"REVERSED\" IS NULL"
        title: Active Entries
        description: Exclude reversed entries
      
      - name: reversed_entries
        sql: "{CUBE}.\"REVERSED\" = true"
        title: Reversed Entries
        description: Reversed entries only

    pre_aggregations:
      # Monthly Trial Balance Summary
      - name: trial_balance_monthly
        measures:
          - count
          - total_amount
          - total_debit_amount
          - total_credit_amount
          - closing_balance
          - net_change_period
        dimensions:
          - g_laccount_no
          - g_laccount_name
          - global_dimension_1_code
          - global_dimension_2_code
          - business_unit_code
          - source_type
          - company_id
        time_dimension: posting_date
        granularity: month
        partition_granularity: year
        refresh_key:
          every: 1 hour
        indexes:
          - name: account_date_idx
            columns:
              - g_l_entry__g_laccount_no
              - g_l_entry__posting_date_month
          - name: dimension_idx
            columns:
              - g_l_entry__global_dimension_1_code
              - g_l_entry__global_dimension_2_code
      
      # Quarterly Trial Balance Summary
      - name: trial_balance_quarterly
        measures:
          - count
          - total_amount
          - total_debit_amount  
          - total_credit_amount
          - ytd_debit
          - ytd_credit
          - ytd_net_change
        dimensions:
          - g_laccount_no
          - g_laccount_name
          - global_dimension_1_code
          - global_dimension_2_code
          - business_unit_code
          - company_id
        time_dimension: posting_date
        granularity: quarter
        partition_granularity: year
        refresh_key:
          every: 1 hour
        indexes:
          - name: account_quarter_idx
            columns:
              - g_l_entry__g_laccount_no
              - g_l_entry__posting_date_quarter
      
      # Daily Trial Balance for Recent Period (90 days)
      - name: trial_balance_daily_recent
        measures:
          - count
          - total_amount
          - total_debit_amount
          - total_credit_amount
        dimensions:
          - g_laccount_no
          - document_no
          - document_type
          - global_dimension_1_code
          - global_dimension_2_code
          - source_type
          - reversed
          - company_id
        time_dimension: posting_date
        granularity: day
        build_range_start:
          sql: "DATEADD('day', -90, CURRENT_DATE())"
        build_range_end:
          sql: "CURRENT_DATE()"
        refresh_key:
          every: 30 minutes
        indexes:
          - name: recent_account_date_idx
            columns:
              - g_l_entry__g_laccount_no
              - g_l_entry__posting_date_day
          - name: recent_document_idx
            columns:
              - g_l_entry__document_no
              - g_l_entry__posting_date_day
      
      # Account Balance by Dimensions
      - name: balance_by_dimensions
        measures:
          - count
          - total_amount
          - total_debit_amount
          - total_credit_amount
          - closing_balance
        dimensions:
          - g_laccount_no
          - global_dimension_1_code
          - global_dimension_2_code
          - shortcut_dimension_3_code
          - shortcut_dimension_4_code
          - business_unit_code
          - company_id
        time_dimension: posting_date
        granularity: month
        partition_granularity: year
        refresh_key:
          every: 1 hour
        indexes:
          - name: dim_balance_idx
            columns:
              - g_l_entry__global_dimension_1_code
              - g_l_entry__global_dimension_2_code
              - g_l_entry__g_laccount_no
      
      # YTD Trial Balance Summary  
      - name: ytd_trial_balance
        measures:
          - ytd_debit
          - ytd_credit
          - ytd_net_change
          - current_year_amount
        dimensions:
          - g_laccount_no
          - g_laccount_name
          - global_dimension_1_code
          - global_dimension_2_code
          - company_id
        segments:
          - current_fiscal_year
        refresh_key:
          every: 1 hour
        indexes:
          - name: ytd_account_idx
            columns:
              - g_l_entry__g_laccount_no
              - g_l_entry__company_id

