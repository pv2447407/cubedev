cubes:
  - name: vendors
    sql_table: {{ env_var('CUBEJS_DB_NAME', 'FIVETRAN_DATABASE') }}.{{ env_var('CUBEJS_DB_SNOWFLAKE_SCHEMA', 'BUSINESS_CENTRAL') }}.VENDOR
    title: Vendors
    description: Vendor master data and analytics
    
    joins:
      - name: purchase_headers
        sql: "{CUBE}.SYSTEMID = {purchase_headers}.VENDOR_ID"
        relationship: one_to_many
        
      - name: purchase_invoices
        sql: "{CUBE}.SYSTEMID = {purchase_invoices}.VENDOR_ID"
        relationship: one_to_many
    
    dimensions:
      - name: system_id
        sql: SYSTEMID
        type: string
        primary_key: true
        
      - name: no
        sql: NO
        type: string
        title: Vendor No.
        
      - name: name
        sql: NAME
        type: string
        
      - name: name_2
        sql: NAME_2
        type: string
        
      - name: search_name
        sql: SEARCH_NAME
        type: string
        
      - name: address
        sql: ADDRESS
        type: string
        
      - name: city
        sql: CITY
        type: string
        
      - name: country_region_code
        sql: COUNTRY_REGION_CODE
        type: string
        
      - name: post_code
        sql: POST_CODE
        type: string
        
      - name: blocked
        sql: BLOCKED
        type: string
        
      - name: currency_code
        sql: CURRENCY_CODE
        type: string
        
      - name: payment_terms_code
        sql: PAYMENT_TERMS_CODE
        type: string
        
      - name: payment_method_code
        sql: PAYMENT_METHOD_CODE
        type: string
        
      - name: purchaser_code
        sql: PURCHASER_CODE
        type: string
        
      - name: vendor_posting_group
        sql: VENDOR_POSTING_GROUP
        type: string
        
      - name: gen_bus_posting_group
        sql: GEN_BUS_POSTING_GROUP
        type: string
        
      - name: vat_registration_no
        sql: VAT_REGISTRATION_NO
        type: string
        
      - name: company_id
        sql: COMPANY_ID
        type: string
        
      - name: last_modified_datetime
        sql: LAST_MODIFIED_DATE_TIME
        type: time
    
    measures:
      - name: count
        type: count
        title: Total Vendors
        
      - name: active_vendors
        type: count
        title: Active Vendors
        filters:
          - sql: "{CUBE}.BLOCKED = '' OR {CUBE}.BLOCKED IS NULL"
          
      - name: blocked_vendors
        type: count
        title: Blocked Vendors
        filters:
          - sql: "{CUBE}.BLOCKED != '' AND {CUBE}.BLOCKED IS NOT NULL"
          
      - name: unique_countries
        sql: COUNTRY_REGION_CODE
        type: count_distinct
        title: Countries Represented
    
    pre_aggregations:
      - name: vendor_summary
        measures:
          - count
          - active_vendors
          - blocked_vendors
        dimensions:
          - country_region_code
          - vendor_posting_group
          - company_id
        refresh_key:
          every: 2 hours
          
  - name: purchase_headers
    sql_table: {{ env_var('CUBEJS_DB_NAME', 'FIVETRAN_DATABASE') }}.{{ env_var('CUBEJS_DB_SNOWFLAKE_SCHEMA', 'BUSINESS_CENTRAL') }}.PURCHASE_HEADER
    title: Purchase Orders
    description: Purchase order headers
    
    joins:
      - name: vendors
        sql: "{CUBE}.VENDOR_ID = {vendors}.SYSTEMID"
        relationship: many_to_one
        
      - name: purchase_lines
        sql: "{CUBE}.SYSTEMID = {purchase_lines}.DOCUMENT_ID"
        relationship: one_to_many
    
    dimensions:
      - name: system_id
        sql: SYSTEMID
        type: string
        primary_key: true
        
      - name: document_type
        sql: DOCUMENT_TYPE
        type: string
        
      - name: no
        sql: NO
        type: string
        title: Document No.
        
      - name: vendor_id
        sql: VENDOR_ID
        type: string
        
      - name: buy_from_vendor_no
        sql: BUY_FROM_VENDOR_NO
        type: string
        title: Vendor No.
        
      - name: buy_from_vendor_name
        sql: BUY_FROM_VENDOR_NAME
        type: string
        title: Vendor Name
        
      - name: posting_date
        sql: POSTING_DATE
        type: time
        
      - name: document_date
        sql: DOCUMENT_DATE
        type: time
        
      - name: due_date
        sql: DUE_DATE
        type: time
        
      - name: expected_receipt_date
        sql: EXPECTED_RECEIPT_DATE
        type: time
        
      - name: status
        sql: STATUS
        type: string
        
      - name: currency_code
        sql: CURRENCY_CODE
        type: string
        
      - name: purchaser_code
        sql: PURCHASER_CODE
        type: string
        
      - name: payment_terms_code
        sql: PAYMENT_TERMS_CODE
        type: string
        
      - name: shipment_method_code
        sql: SHIPMENT_METHOD_CODE
        type: string
        
      - name: location_code
        sql: LOCATION_CODE
        type: string
        
      - name: amount
        sql: AMOUNT
        type: number
        format: currency
        
      - name: amount_including_vat
        sql: AMOUNT_INCLUDING_VAT
        type: number
        format: currency
        
      - name: company_id
        sql: COMPANY_ID
        type: string
    
    measures:
      - name: count
        type: count
        title: Total Documents
        
      - name: quote_count
        type: count
        title: Quotes
        filters:
          - sql: "{CUBE}.DOCUMENT_TYPE = 'Quote'"
          
      - name: order_count
        type: count
        title: Purchase Orders
        filters:
          - sql: "{CUBE}.DOCUMENT_TYPE = 'Order'"
          
      - name: invoice_count
        type: count
        title: Invoices
        filters:
          - sql: "{CUBE}.DOCUMENT_TYPE = 'Invoice'"
          
      - name: credit_memo_count
        type: count
        title: Credit Memos
        filters:
          - sql: "{CUBE}.DOCUMENT_TYPE = 'Credit Memo'"
          
      - name: total_amount
        sql: AMOUNT
        type: sum
        title: Total Amount
        format: currency
        
      - name: total_amount_incl_vat
        sql: AMOUNT_INCLUDING_VAT
        type: sum
        title: Total Amount (Incl. VAT)
        format: currency
        
      - name: open_orders_count
        type: count
        title: Open Orders
        filters:
          - sql: "{CUBE}.STATUS = 'Open'"
          - sql: "{CUBE}.DOCUMENT_TYPE = 'Order'"
          
      - name: open_orders_value
        sql: AMOUNT
        type: sum
        title: Open Orders Value
        format: currency
        filters:
          - sql: "{CUBE}.STATUS = 'Open'"
          - sql: "{CUBE}.DOCUMENT_TYPE = 'Order'"
          
      - name: unique_vendors
        sql: VENDOR_ID
        type: count_distinct
        title: Unique Vendors
        
      - name: avg_order_value
        sql: AMOUNT
        type: avg
        title: Average Order Value
        format: currency
        filters:
          - sql: "{CUBE}.DOCUMENT_TYPE = 'Order'"
    
    pre_aggregations:
      - name: purchase_summary_daily
        measures:
          - count
          - order_count
          - total_amount
          - unique_vendors
        dimensions:
          - document_type
          - status
          - company_id
        time_dimension: posting_date
        granularity: day
        refresh_key:
          every: 1 hour
          
  - name: purchase_lines
    sql_table: {{ env_var('CUBEJS_DB_NAME', 'FIVETRAN_DATABASE') }}.{{ env_var('CUBEJS_DB_SNOWFLAKE_SCHEMA', 'BUSINESS_CENTRAL') }}.PURCHASE_LINE
    title: Purchase Lines
    description: Purchase order line details
    
    joins:
      - name: purchase_headers
        sql: "{CUBE}.DOCUMENT_ID = {purchase_headers}.SYSTEMID"
        relationship: many_to_one
        
    
    dimensions:
      - name: system_id
        sql: SYSTEMID
        type: string
        primary_key: true
        
      - name: document_id
        sql: DOCUMENT_ID
        type: string
        
      - name: document_type
        sql: DOCUMENT_TYPE
        type: string
        
      - name: document_no
        sql: DOCUMENT_NO
        type: string
        
      - name: line_no
        sql: LINE_NO
        type: number
        
      - name: type
        sql: TYPE
        type: string
        
      - name: no
        sql: NO
        type: string
        title: Item/Account No.
        
      - name: description
        sql: DESCRIPTION
        type: string
        
      - name: location_code
        sql: LOCATION_CODE
        type: string
        
      - name: unit_of_measure_code
        sql: UNIT_OF_MEASURE_CODE
        type: string
        
      - name: quantity
        sql: QUANTITY
        type: number
        
      - name: direct_unit_cost
        sql: DIRECT_UNIT_COST
        type: number
        format: currency
        
      - name: unit_cost_lcy
        sql: UNIT_COST_LCY
        type: number
        format: currency
        
      - name: line_discount_percent
        sql: LINE_DISCOUNT_PERCENT
        type: number
        format: percent
        
      - name: line_amount
        sql: LINE_AMOUNT
        type: number
        format: currency
        
      - name: amount
        sql: AMOUNT
        type: number
        format: currency
        
      - name: amount_including_vat
        sql: AMOUNT_INCLUDING_VAT
        type: number
        format: currency
        
      - name: outstanding_quantity
        sql: OUTSTANDING_QUANTITY
        type: number
        
      - name: quantity_received
        sql: QUANTITY_RECEIVED
        type: number
        
      - name: quantity_invoiced
        sql: QUANTITY_INVOICED
        type: number
        
      - name: company_id
        sql: COMPANY_ID
        type: string
    
    measures:
      - name: count
        type: count
        title: Total Lines
        
      - name: total_quantity
        sql: QUANTITY
        type: sum
        title: Total Quantity Ordered
        
      - name: total_amount
        sql: AMOUNT
        type: sum
        title: Total Amount
        format: currency
        
      - name: avg_unit_cost
        sql: DIRECT_UNIT_COST
        type: avg
        title: Average Unit Cost
        format: currency
        
      - name: total_outstanding_qty
        sql: OUTSTANDING_QUANTITY
        type: sum
        title: Outstanding Quantity
        
      - name: total_received_qty
        sql: QUANTITY_RECEIVED
        type: sum
        title: Quantity Received
        
      - name: unique_items_purchased
        sql: NO
        type: count_distinct
        title: Unique Items Purchased
        filters:
          - sql: "{CUBE}.TYPE = 'Item'"
          
  - name: purchase_invoices
    sql_table: {{ env_var('CUBEJS_DB_NAME', 'FIVETRAN_DATABASE') }}.{{ env_var('CUBEJS_DB_SNOWFLAKE_SCHEMA', 'BUSINESS_CENTRAL') }}.PURCH_INV_HEADER
    title: Posted Purchase Invoices
    description: Posted purchase invoice headers
    
    joins:
      - name: vendors
        sql: "{CUBE}.VENDOR_ID = {vendors}.SYSTEMID"
        relationship: many_to_one
        
      # - name: purchase_invoice_lines
      #   sql: "{CUBE}.SYSTEMID = {purchase_invoice_lines}.DOCUMENT_ID"
      #   relationship: one_to_many
      # Note: purchase_invoice_lines cube needs to be defined
    
    dimensions:
      - name: system_id
        sql: SYSTEMID
        type: string
        primary_key: true
        
      - name: no
        sql: NO
        type: string
        title: Invoice No.
        
      - name: vendor_id
        sql: VENDOR_ID
        type: string
        
      - name: buy_from_vendor_no
        sql: BUY_FROM_VENDOR_NO
        type: string
        title: Vendor No.
        
      - name: buy_from_vendor_name
        sql: BUY_FROM_VENDOR_NAME
        type: string
        title: Vendor Name
        
      - name: posting_date
        sql: POSTING_DATE
        type: time
        
      - name: document_date
        sql: DOCUMENT_DATE
        type: time
        
      - name: due_date
        sql: DUE_DATE
        type: time
        
      - name: vendor_invoice_no
        sql: VENDOR_INVOICE_NO
        type: string
        title: Vendor Invoice No.
        
      - name: currency_code
        sql: CURRENCY_CODE
        type: string
        
      - name: amount
        sql: AMOUNT
        type: number
        format: currency
        
      - name: amount_including_vat
        sql: AMOUNT_INCLUDING_VAT
        type: number
        format: currency
        
      - name: remaining_amount
        sql: REMAINING_AMOUNT
        type: number
        format: currency
        
      - name: payment_method_code
        sql: PAYMENT_METHOD_CODE
        type: string
        
      - name: company_id
        sql: COMPANY_ID
        type: string
    
    measures:
      - name: count
        type: count
        title: Total Invoices
        
      - name: total_purchases
        sql: AMOUNT
        type: sum
        title: Total Purchases
        format: currency
        
      - name: total_purchases_incl_vat
        sql: AMOUNT_INCLUDING_VAT
        type: sum
        title: Total Purchases (Incl. VAT)
        format: currency
        
      - name: total_outstanding
        sql: REMAINING_AMOUNT
        type: sum
        title: Total Outstanding
        format: currency
        
      - name: paid_invoices
        type: count
        title: Paid Invoices
        filters:
          - sql: "{CUBE}.REMAINING_AMOUNT = 0"
          
      - name: unpaid_invoices
        type: count
        title: Unpaid Invoices
        filters:
          - sql: "{CUBE}.REMAINING_AMOUNT > 0"
          
      - name: overdue_invoices
        type: count
        title: Overdue Invoices
        filters:
          - sql: "{CUBE}.REMAINING_AMOUNT > 0 AND {CUBE}.DUE_DATE < CURRENT_DATE()"
          
      - name: unique_vendors
        sql: VENDOR_ID
        type: count_distinct
        title: Unique Vendors
        
      - name: days_payable_outstanding
        sql: |
          SUM(REMAINING_AMOUNT) / NULLIF(SUM(AMOUNT) / 365.0, 0)
        type: number
        title: DPO (Days Payable Outstanding)
        format: number