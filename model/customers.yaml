cubes:
  - name: customers
    sql_table: "{{ env_var('CUBEJS_DB_NAME') | safe }}.{{ env_var('CUBEJS_DB_SNOWFLAKE_SCHEMA') | safe }}.CUSTOMER"
    title: Customers
    description: Customer master data and analytics
    
    joins:
      - name: sales_headers
        sql: "{CUBE}.SYSTEMID = {sales_headers}.CUSTOMER_ID"
        relationship: one_to_many
    
    dimensions:
      - name: system_id
        sql: SYSTEMID
        type: string
        primary_key: true
        
      - name: customer_no
        sql: NO
        type: string
        title: Customer Number
        
      - name: name
        sql: NAME
        type: string
        
      - name: name_2
        sql: NAME_2
        type: string
        title: Name 2
        
      - name: search_name
        sql: SEARCH_NAME
        type: string
        
      - name: address
        sql: ADDRESS
        type: string
        
      - name: city
        sql: CITY
        type: string
        
      - name: country_region_code
        sql: COUNTRY_REGION_CODE
        type: string
        title: Country/Region
        
      - name: post_code
        sql: POST_CODE
        type: string
        title: Postal Code
        
      - name: blocked
        sql: BLOCKED
        type: string
        title: Blocked Status
        
      - name: credit_limit_lcy
        sql: CREDIT_LIMIT_LCY
        type: number
        title: Credit Limit (LCY)
        format: currency
        
      - name: currency_code
        sql: CURRENCY_CODE
        type: string
        
      - name: payment_terms_code
        sql: PAYMENT_TERMS_CODE
        type: string
        title: Payment Terms
        
      - name: payment_method_code
        sql: PAYMENT_METHOD_CODE
        type: string
        title: Payment Method
        
      - name: salesperson_code
        sql: SALESPERSON_CODE
        type: string
        title: Salesperson
        
      - name: customer_posting_group
        sql: CUSTOMER_POSTING_GROUP
        type: string
        title: Posting Group
        
      - name: gen_bus_posting_group
        sql: GEN_BUS_POSTING_GROUP
        type: string
        title: Gen. Business Posting Group
        
      - name: vat_registration_no
        sql: VAT_REGISTRATION_NO
        type: string
        title: VAT Registration No.
        
      - name: company_id
        sql: COMPANY_ID
        type: string
        title: Company
        
      - name: last_modified_datetime
        sql: LAST_MODIFIED_DATE_TIME
        type: time
        
      - name: created_datetime
        sql: "{CUBE}._FIVETRAN_SYNCED"
        type: time
        title: First Synced
    
    measures:
      - name: count
        type: count
        title: Total Customers
        
      - name: active_count
        type: count
        title: Active Customers
        filters:
          - sql: "{CUBE}.BLOCKED = '' OR {CUBE}.BLOCKED IS NULL"
          
      - name: blocked_count
        type: count
        title: Blocked Customers
        filters:
          - sql: "{CUBE}.BLOCKED != '' AND {CUBE}.BLOCKED IS NOT NULL"
          
      - name: total_credit_limit
        sql: CREDIT_LIMIT_LCY
        type: sum
        title: Total Credit Limit
        format: currency
        
      - name: avg_credit_limit
        sql: CREDIT_LIMIT_LCY
        type: avg
        title: Average Credit Limit
        format: currency
        
      - name: customers_with_credit_limit
        type: count
        title: Customers with Credit Limit
        filters:
          - sql: "{CUBE}.CREDIT_LIMIT_LCY > 0"
          
    pre_aggregations:
      - name: customer_summary
        measures:
          - count
          - active_count
          - blocked_count
          - total_credit_limit
        dimensions:
          - country_region_code
          - customer_posting_group
          - company_id
        time_dimension: created_datetime
        granularity: month
        refresh_key:
          every: 1 hour